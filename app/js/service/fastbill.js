!function(){"use strict";var t=require("angular"),e=require("../model/customer"),i=function(t,e,i){this.client=require("fastbill-client"),this.$q=t,this.$rootScope=e,this.$log=i,this.authenticated=!1,this.initialize()};i.prototype.initialize=function(){this.restoreState()},i.prototype.restoreState=function(){var e,i,r=this;try{e=localStorage._credentials,e&&(this.deferred=this.$q.defer(),i=t.fromJson(e),this.login(i.username,i.apiKey).then(function(){r.deferred.resolve(!0),r.deferred=null},function(){r.deferred.resolve(!1)}))}catch(n){this.$log.warn("[FastBill] error restoring state:",n)}},i.prototype.saveState=function(){try{localStorage._credentials=t.toJson(this.credentials)}catch(e){this.$log.warn("[FastBill] error saving state:",e)}},i.prototype.clearState=function(){try{delete localStorage._credentials}catch(t){this.$log.warn("[FastBill] error clearing state:",t)}},i.prototype.ensureAuthenticated=function(){if(!this.authenticated)throw"You need to call login before accessing any api method"},i.prototype.login=function(t,e){var i=this.$q.defer(),r=this;return this.client.bootstrap(t,e),this.client.api.customer.get().then(function(){r.$log.debug("[FastBill] login success"),r.authenticated=!0,r.credentials={username:t,apiKey:e},r.saveState(),r.$rootScope.$broadcast("authenticated"),i.resolve()},function(t){r.$log.warn("[FastBill] login failed",t),r.$rootScope.$broadcast("not-authenticated"),i.reject()}),i.promise},i.prototype.getCustomers=function(){return this.ensureAuthenticated(),this.client.api.customer.get().then(function(t){var i=[];return t.forEach(function(t){i.push(new e(t))}),i})},i.prototype.getCustomer=function(t){return this.ensureAuthenticated(),this.client.api.customer.getById(t).then(function(t){return t&&t.length?new e(t[0]):null})},i.prototype.isAuthenticated=function(){if(this.deferred)return this.deferred.promise;var t=this.$q.defer();return t.resolve(this.authenticated),t.promise},i.prototype.getInvoices=function(t){this.ensureAuthenticated(),this.$log.debug("[FastBill] getInvoices",t);var e=require("../model/invoice"),i=function(t){var i=[];return t.forEach(function(t){i.push(new e(t))}),i};return t?this.client.api.invoice.getByCustomerId(t).then(i):this.client.api.invoice.get().then(i)},i.prototype.getProjects=function(t){this.ensureAuthenticated();var e=require("../model/project"),i=function(t){var i=[];return t.forEach(function(t){i.push(new e(t))}),i};return t?this.client.api.project.getByCustomerId(t).then(i):this.client.api.project.get().then(i)},i.prototype.logout=function(){this.authenticated=!1,this.credentials=null,this.clearState()},module.exports=["$q","$rootScope","$log",function(t,e,r){return new i(t,e,r)}]}();
//# sourceMappingURL=../service/fastbill.js.map